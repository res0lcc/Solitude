{% extends "base.html" %}
{% block title %}注册{% endblock %}
{% block page_title %}注册{% endblock %}
{% block content %}
<div class="mdui-card auth-card">
    <div class="mdui-card-primary">
        <div class="mdui-card-primary-title">开始记录你的每一天</div>
        <div class="mdui-card-primary-subtitle">创建你的账号</div>
    </div>
    <div class="mdui-card-content">
        <form id="register-form" method="POST" novalidate>
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">用户名</label>
                <input class="mdui-textfield-input" type="text" name="username" required
                    pattern="^[a-zA-Z0-9_]{3,20}$"/>
                <div class="mdui-textfield-helper">只能包含字母、数字和下划线，长度3-20位</div>
            </div>
            
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">昵称</label>
                <input class="mdui-textfield-input" type="text" name="nickname"/>
            </div>
            
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">密码</label>
                <input class="mdui-textfield-input" type="password" id="password" name="password" required oninput="checkPasswordStrength(this.value)"/>
                <div class="mdui-textfield-helper">
                    <div class="password-strength">
                        <div class="strength-text">密码强度：<span id="strength-text">弱</span></div>
                        <div class="strength-bar">
                            <div id="strength-indicator"></div>
                        </div>
                    </div>
                    <div class="password-requirements">
                        至少包含6个字符，建议使用字母、数字和符号的组合
                    </div>
                </div>
            </div>
            
            <div class="mdui-textfield mdui-textfield-floating-label">
                <label class="mdui-textfield-label">确认密码</label>
                <input class="mdui-textfield-input" type="password" id="confirmPassword" required/>
            </div>

            <!-- 暂时隐藏验证码部分 -->
            <!-- <div class="captcha-group">...</div> -->

            <div class="register-actions">
                <button type="submit" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme">注册账号</button>
                <div class="agreement-text">
                    <div>已有账号？<a href="/login" class="mdui-text-color-theme">立即登录</a></div>
                    <div class="sub-text">注册即表示同意服务协议和隐私政策</div>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
.auth-card {
    max-width: 400px;
    margin: 40px auto;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

/* 调整输入框容器的样式 */
.mdui-textfield {
    margin: 0;  /* 移除垂直间距 */
    padding-top: 6px;  /* 减小顶部内边距 */
    padding-bottom: 16px;  /* 减小底部内边距 */
    min-height: unset;  /* 移除最小高度限制 */
}

/* 调整标签和输入框间距 */
.mdui-textfield-label {
    top: 10px;  /* 调整标签位置 */
}

/* 调整帮助文本样式 */
.mdui-textfield-helper {
    position: relative;
    margin-top: 10px;
    font-size: 11px;
    line-height: 1.2;
    color: rgba(0,0,0,.54);
}

/* 密码强度指示器调整 */
.password-strength {
    margin: 2px 0;
}

.strength-text {
    font-size: 11px;
    margin-bottom: 2px;
}

.strength-bar {
    height: 3px;  /* 减小高度 */
}

.password-requirements {
    margin-top: 2px;
    font-size: 11px;
}

/* 调整卡片内容区域内边距 */
.mdui-card-primary {
    padding: 20px;
}

.mdui-card-content {
    padding: 16px 20px;
}

/* 调整按钮区域样式 */
.register-actions {
    margin-top: 20px;  /* 减小上边距 */
    text-align: center;  /* 居中对齐 */
}

.register-actions .mdui-btn {
    width: 100%;
    height: 40px;
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 0.5px;
    margin-bottom: 16px;
}

.agreement-text {
    text-align: center;  /* 确保文本居中 */
    font-size: 13px;
}

.sub-text {
    margin-top: 6px;
    font-size: 11px;
    color: rgba(0,0,0,0.4);
}

.agreement-text a {
    text-decoration: none;
}

/* 移除多余的样式 */
.mdui-textfield-floating-label .mdui-textfield-label {
    pointer-events: none;
}

@media (max-width: 480px) {
    .auth-card {
        margin: 20px 16px;
    }
}
</style>

<script>
function refreshCaptcha() {
    const display = document.getElementById('captcha-display');
    display.style.backgroundColor = '#f5f5f5';
    display.textContent = '1234';
}

document.getElementById('register-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    fetch('/create_user', {
        method: 'POST',
        body: formData  // 直接使用 FormData，不需要转换为 JSON
    })
    .then(response => response.json())
    .then(data => {
        if(data.error === '验证码错误') {
            mdui.snackbar({message: '验证码错误'});
            refreshCaptcha();
        } else if(data.success) {
            mdui.snackbar({
                message: '注册成功！正在跳转到登录页面...',
                timeout: 1500,
                onClose: () => {
                    window.location.href = '/login';
                }
            });
        } else {
            mdui.snackbar({message: data.message || '注册失败'});
            refreshCaptcha();
        }
    })
    .catch(error => {
        mdui.snackbar({message: '服务器错误，请稍后重试'});
        refreshCaptcha();
    });
});

// 确认密码检查
document.getElementById('confirmPassword').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    if (this.value !== password) {
        this.setCustomValidity('两次输入的密码不一致');
    } else {
        this.setCustomValidity('');
    }
});

function checkPasswordStrength(password) {
    const strengthText = document.getElementById('strength-text');
    const strengthBar = document.querySelector('.strength-bar');
    
    // 检查密码强度
    let strength = 0;
    if (password.length >= 6) strength++;
    if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
    if (password.match(/[0-9]/)) strength++;
    if (password.match(/[^a-zA-Z0-9]/)) strength++;
    
    // 更新UI
    strengthBar.className = 'strength-bar';
    switch(true) {
        case (strength <= 1):
            strengthText.textContent = '弱';
            strengthBar.classList.add('strength-weak');
            break;
        case (strength <= 2):
            strengthText.textContent = '中';
            strengthBar.classList.add('strength-medium');
            break;
        default:
            strengthText.textContent = '强';
            strengthBar.classList.add('strength-strong');
    }
}
</script>
{% endblock %}