{% extends "base.html" %}
{% block title %}编辑日记{% endblock %}
{% block page_title %}编辑日记{% endblock %}
{% block content %}
<div class="diary-card">
    <div class="diary-header">
        <h2 class="diary-title">编辑日记</h2>
    </div>
    <div class="diary-content">
        <form id="edit-diary-form" method="POST" data-diary-id="{{ diary.id }}">
            <div class="diary-meta">
                <div class="meta-item">
                    <label>标题</label>
                    <input type="text" name="title" placeholder="标题" required class="mdui-textfield-input diary-title-input" value="{{ diary.title or '' }}">
                </div>
                <div class="meta-item">
                    <label>日期</label>
                    <input type="date" name="date" value="{{ diary.created_at.strftime('%Y-%m-%d') }}" required class="date-input">
                </div>
                <div class="meta-item">
                    <label>心情</label>
                    <select name="mood" class="mdui-select mood-select" mdui-select>
                        <option value="开心" {% if diary.mood == '开心' %}selected{% endif %}>心情开心</option>
                        <option value="平静" {% if diary.mood == '平静' %}selected{% endif %}>心情平静</option>
                        <option value="伤心" {% if diary.mood == '伤心' %}selected{% endif %}>心情伤心</option>
                        <option value="生气" {% if diary.mood == '生气' %}selected{% endif %}>心情生气</option>
                        <option value="疲惫" {% if diary.mood == '疲惫' %}selected{% endif %}>心情疲惫</option>
                    </select>
                </div>
                <div class="meta-item">
                    <label>位置</label>
                    <div class="location">
                        <i class="mdui-icon material-icons">location_on</i>
                        <span id="ip-location">{{ diary.location or '未知位置' }}</span>
                        <input type="hidden" name="location" id="location-input" value="{{ diary.location or '' }}">
                    </div>
                </div>
            </div>
            
            <div class="input-group content-group">
                <textarea name="content" placeholder="今天想说什么..." rows="10" required class="mdui-textfield-input diary-content-input">{{ diary.content or '' }}</textarea>
            </div>
            
            <div class="diary-options">
                <label class="mdui-checkbox">
                    <input type="checkbox" name="is_public" {% if diary.is_public %}checked{% endif %}/>
                    <i class="mdui-checkbox-icon"></i>
                    <span>公开发布</span>
                </label>
            </div>
            
            <div class="diary-actions">
                <button type="submit" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme">更新日记</button>
                <button type="button" onclick="deleteDiary()" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-red">删除日记</button>
            </div>
        </form>
    </div>
</div>

<style>
.diary-meta {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.meta-item label {
    color: #666;
    font-size: 0.9em;
}

.diary-title-input,
.date-input,
.mood-select,
.location {
    width: 100%;
    padding: 8px 12px;
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
}

.location {
    display: flex;
    align-items: center;
    gap: 8px;
}

// ...existing code from add.html...

.diary-card {
    max-width: 700px;
    margin: 20px auto;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .diary-card {
        margin: 10px;
        padding: 15px;
    }
    
    .meta-item {
        margin-bottom: 15px;
    }
    
    .diary-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .diary-actions button {
        width: 100%;
    }
}
</style>

<script>
// 初始化 MDUI 组件
var inst = new mdui.Select('#weather-select');

const emojiList = ['😊', '😂', '🥰', '😎', '🤔', '😴', '🌞', '🌙', '⭐', '🌈', '🎵', '❤️'];

function insertEmoji() {
    const picker = new mdui.Dialog(`
        <div class="emoji-picker">
            ${emojiList.map(emoji => `
                <button type="button" onclick="insertEmojiToContent('${emoji}')" class="emoji-btn">
                    ${emoji}
                </button>
            `).join('')}
        </div>
    `, {
        buttons: [{text: '关闭'}]
    });
    picker.open();
}

function insertEmojiToContent(emoji) {
    const textarea = document.querySelector('.diary-content-input');
    const pos = textarea.selectionStart;
    const text = textarea.value;
    textarea.value = text.slice(0, pos) + emoji + text.slice(pos);
}

document.getElementById('edit-diary-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const diaryId = this.getAttribute('data-diary-id');
    
    const formData = {
        title: this.querySelector('[name="title"]').value.trim(),
        content: this.querySelector('[name="content"]').value.trim(),
        mood: this.querySelector('[name="mood"]').value,
        date: this.querySelector('[name="date"]').value,  // 添加日期
        location: document.getElementById('location-input').value.trim(),
        is_public: this.querySelector('[name="is_public"]').checked
    };

    try {
        const response = await fetch(`/edit/${diaryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            mdui.snackbar({
                message: '更新成功！',
                timeout: 1500,
                onClose: () => {
                    window.location.href = formData.is_public ? '/wall' : '/';
                }
            });
        } else {
            throw new Error(result.error || '更新失败');
        }
    } catch (error) {
        console.error('Error:', error);
        mdui.snackbar({
            message: error.message || '更新失败，请稍后重试',
            timeout: 2000
        });
    }
});

async function deleteDiary() {
    if (!confirm('确定要删除这篇日记吗？此操作不可恢复。')) {
        return;
    }

    const diaryId = document.getElementById('edit-diary-form').getAttribute('data-diary-id');
    
    try {
        const response = await fetch(`/api/diary/${diaryId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            mdui.snackbar({
                message: '日记已删除',
                timeout: 1500,
                onClose: () => {
                    window.history.back();  // 修改为返回上一页
                }
            });
        } else {
            throw new Error(result.error || '删除失败');
        }
    } catch (error) {
        console.error('Error:', error);
        mdui.snackbar({
            message: error.message || '删除失败，请稍后重试',
            timeout: 2000
        });
    }
}
</script>
<script src="{{ url_for('static', filename='js/diary.js') }}"></script>
{% endblock %}