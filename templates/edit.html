{% extends "base.html" %}
{% block title %}ç¼–è¾‘æ—¥è®°{% endblock %}
{% block page_title %}ç¼–è¾‘æ—¥è®°{% endblock %}
{% block content %}
<div class="diary-card">
    <div class="diary-header">
        <h2 class="diary-title">ç¼–è¾‘æ—¥è®°</h2>
    </div>
    <div class="diary-content">
        <form id="edit-diary-form" method="POST" data-diary-id="{{ diary.id }}">
            <div class="diary-meta">
                <div class="meta-item">
                    <label>æ ‡é¢˜</label>
                    <input type="text" name="title" placeholder="æ ‡é¢˜" required class="mdui-textfield-input diary-title-input" value="{{ diary.title or '' }}">
                </div>
                <div class="meta-item">
                    <label>æ—¥æœŸ</label>
                    <input type="date" name="date" value="{{ diary.created_at.strftime('%Y-%m-%d') }}" required class="date-input">
                </div>
                <div class="meta-item">
                    <label>å¿ƒæƒ…</label>
                    <select name="mood" class="mdui-select mood-select" mdui-select>
                        <option value="å¼€å¿ƒ" {% if diary.mood == 'å¼€å¿ƒ' %}selected{% endif %}>å¿ƒæƒ…å¼€å¿ƒ</option>
                        <option value="å¹³é™" {% if diary.mood == 'å¹³é™' %}selected{% endif %}>å¿ƒæƒ…å¹³é™</option>
                        <option value="ä¼¤å¿ƒ" {% if diary.mood == 'ä¼¤å¿ƒ' %}selected{% endif %}>å¿ƒæƒ…ä¼¤å¿ƒ</option>
                        <option value="ç”Ÿæ°”" {% if diary.mood == 'ç”Ÿæ°”' %}selected{% endif %}>å¿ƒæƒ…ç”Ÿæ°”</option>
                        <option value="ç–²æƒ«" {% if diary.mood == 'ç–²æƒ«' %}selected{% endif %}>å¿ƒæƒ…ç–²æƒ«</option>
                    </select>
                </div>
                <div class="meta-item">
                    <label>ä½ç½®</label>
                    <div class="location">
                        <i class="mdui-icon material-icons">location_on</i>
                        <span id="ip-location">{{ diary.location or 'æœªçŸ¥ä½ç½®' }}</span>
                        <input type="hidden" name="location" id="location-input" value="{{ diary.location or '' }}">
                    </div>
                </div>
            </div>
            
            <div class="input-group content-group">
                <textarea name="content" placeholder="ä»Šå¤©æƒ³è¯´ä»€ä¹ˆ..." rows="10" required class="mdui-textfield-input diary-content-input">{{ diary.content or '' }}</textarea>
            </div>
            
            <div class="diary-options">
                <label class="mdui-checkbox">
                    <input type="checkbox" name="is_public" {% if diary.is_public %}checked{% endif %}/>
                    <i class="mdui-checkbox-icon"></i>
                    <span>å…¬å¼€å‘å¸ƒ</span>
                </label>
            </div>
            
            <div class="diary-actions">
                <button type="submit" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme">æ›´æ–°æ—¥è®°</button>
                <button type="button" onclick="deleteDiary()" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-red">åˆ é™¤æ—¥è®°</button>
            </div>
        </form>
    </div>
</div>

<style>
.diary-meta {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.meta-item label {
    color: #666;
    font-size: 0.9em;
}

.diary-title-input,
.date-input,
.mood-select,
.location {
    width: 100%;
    padding: 8px 12px;
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
}

.location {
    display: flex;
    align-items: center;
    gap: 8px;
}

// ...existing code from add.html...

.diary-card {
    max-width: 700px;
    margin: 20px auto;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .diary-card {
        margin: 10px;
        padding: 15px;
    }
    
    .meta-item {
        margin-bottom: 15px;
    }
    
    .diary-actions {
        flex-direction: column;
        gap: 10px;
    }
    
    .diary-actions button {
        width: 100%;
    }
}
</style>

<script>
// åˆå§‹åŒ– MDUI ç»„ä»¶
var inst = new mdui.Select('#weather-select');

const emojiList = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜´', 'ğŸŒ', 'ğŸŒ™', 'â­', 'ğŸŒˆ', 'ğŸµ', 'â¤ï¸'];

function insertEmoji() {
    const picker = new mdui.Dialog(`
        <div class="emoji-picker">
            ${emojiList.map(emoji => `
                <button type="button" onclick="insertEmojiToContent('${emoji}')" class="emoji-btn">
                    ${emoji}
                </button>
            `).join('')}
        </div>
    `, {
        buttons: [{text: 'å…³é—­'}]
    });
    picker.open();
}

function insertEmojiToContent(emoji) {
    const textarea = document.querySelector('.diary-content-input');
    const pos = textarea.selectionStart;
    const text = textarea.value;
    textarea.value = text.slice(0, pos) + emoji + text.slice(pos);
}

document.getElementById('edit-diary-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const diaryId = this.getAttribute('data-diary-id');
    
    const formData = {
        title: this.querySelector('[name="title"]').value.trim(),
        content: this.querySelector('[name="content"]').value.trim(),
        mood: this.querySelector('[name="mood"]').value,
        date: this.querySelector('[name="date"]').value,  // æ·»åŠ æ—¥æœŸ
        location: document.getElementById('location-input').value.trim(),
        is_public: this.querySelector('[name="is_public"]').checked
    };

    try {
        const response = await fetch(`/edit/${diaryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            mdui.snackbar({
                message: 'æ›´æ–°æˆåŠŸï¼',
                timeout: 1500,
                onClose: () => {
                    window.location.href = formData.is_public ? '/wall' : '/';
                }
            });
        } else {
            throw new Error(result.error || 'æ›´æ–°å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        mdui.snackbar({
            message: error.message || 'æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
            timeout: 2000
        });
    }
});

async function deleteDiary() {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
    }

    const diaryId = document.getElementById('edit-diary-form').getAttribute('data-diary-id');
    
    try {
        const response = await fetch(`/api/diary/${diaryId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
            mdui.snackbar({
                message: 'æ—¥è®°å·²åˆ é™¤',
                timeout: 1500,
                onClose: () => {
                    window.history.back();  // ä¿®æ”¹ä¸ºè¿”å›ä¸Šä¸€é¡µ
                }
            });
        } else {
            throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
        }
    } catch (error) {
        console.error('Error:', error);
        mdui.snackbar({
            message: error.message || 'åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
            timeout: 2000
        });
    }
}
</script>
<script src="{{ url_for('static', filename='js/diary.js') }}"></script>
{% endblock %}